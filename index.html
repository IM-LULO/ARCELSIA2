<!DOCTYPE html>
<html>
  <head>
    <title>Modelo 3D con Geolocalización Simplificada</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXISwnR8BTbDdDjfwPuQvbhYustREcQdg"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- Mensaje inicial para solicitar permisos -->
    <div id="permission-request" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px;">
      <p>Esta aplicación necesita acceso a tu ubicación para funcionar correctamente. Por favor, permite el acceso.</p>
      <button id="permission-button" style="padding: 10px 20px; font-size: 16px;">Permitir Ubicación</button>
    </div>

    <!-- Escena de A-Frame -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      style="display: none;"
    >
      <!-- Cámara GPS -->
      <a-camera gps-camera rotation-reader position="0 0 0"></a-camera>

      <script>
        // Coordenadas objetivo
        const targetLatitude = 3.34071628;
        const targetLongitude = -76.52940404;
        const toleranceInMeters = 50; // Tolerancia de 50 metros

        // Elementos del DOM
        const permissionRequestDiv = document.getElementById("permission-request");
        const permissionButton = document.getElementById("permission-button");
        const aScene = document.querySelector("a-scene");

        // Solicitar acceso a la ubicación
        permissionButton.addEventListener("click", () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                console.log("Permisos otorgados. Latitud:", position.coords.latitude, "Longitud:", position.coords.longitude);
                permissionRequestDiv.style.display = "none"; // Oculta el mensaje de permisos
                aScene.style.display = "block"; // Muestra la escena

                // Compara la ubicación actual con las coordenadas objetivo
                checkProximity(position.coords.latitude, position.coords.longitude);
              },
              (error) => {
                console.error("Error al obtener la ubicación:", error);
                alert("Por favor, permite el acceso a la ubicación para usar esta aplicación.");
              }
            );
          } else {
            alert("Tu navegador no soporta geolocalización.");
          }
        });

        // Verifica si la ubicación está dentro del rango de tolerancia
        function checkProximity(currentLatitude, currentLongitude) {
          const model = document.querySelector("#model");

          // Calcula la diferencia en metros entre la ubicación actual y el objetivo
          const distanceLat = Math.abs(targetLatitude - currentLatitude) * 111320; // 1 grado de latitud = 111.32 km
          const distanceLon = Math.abs(targetLongitude - currentLongitude) * (40075000 * Math.cos((currentLatitude * Math.PI) / 180) / 360); // Ajusta con longitud

          const distance = Math.sqrt(distanceLat ** 2 + distanceLon ** 2);

          console.log("Distancia aproximada al objetivo:", distance, "metros");

          // Muestra el modelo si está dentro de la tolerancia
          if (distance <= toleranceInMeters) {
            console.log("Dentro del rango de tolerancia. Mostrando el modelo.");
            model.setAttribute("visible", "true");
          } else {
            console.log("Fuera del rango de tolerancia. Ocultando el modelo.");
            model.setAttribute("visible", "false");
          }
        }
      </script>

      <!-- Modelo 3D -->
      <a-entity
        id="model"
        gps-entity-place="latitude: 3.34071628; longitude: -76.52940404;"
        gltf-model="logocelsia.glb"
        scale="1 1 1" 
        position="0 0 0" 
        visible="false" 
        static-body 
      ></a-entity>
    </a-scene>

    <!-- Instrucciones -->
    <div style="position: absolute; bottom: 10px; text-align: center; width: 100%; color: white; background: rgba(0,0,0,0.5); padding: 5px;">
      <p>Muévete hacia las coordenadas especificadas para visualizar el modelo 3D correctamente.</p>
    </div>
  </body>
</html>
