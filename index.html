<!DOCTYPE html>
<html>
  <head>
    <title>AR Experience with Coordinates & Range</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- AR Scene -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      style="width: 100vw; height: 100vh;"
    >
      <!-- GPS Camera (actualizado con gpsMinDistance) -->
      <a-camera
        gps-camera="gpsMinDistance: 1"
        rotation-reader
        position="0 0 0"
        id="gpscam"
      ></a-camera>

      <!-- 3D Model at Specific Coordinates (initially hidden) -->
      <a-entity
        id="model"
        gps-entity-place="latitude: 3.34071628; longitude: -76.52940404; altitude: 1020.56742902"
        gltf-model="logocelsia.glb"
        scale="1 1 1"
        position="0 0 0"
        visible="false"
      ></a-entity>
    </a-scene>

    <!-- Instructions -->
    <div style="position: absolute; bottom: 10px; text-align: center; width: 100%;">
      <p>
        El modelo 3D es fijo en la ubicación GPS. Solo puedes visualizarlo si estás a menos de 20 metros de distancia.<br>
        Muévete con tu dispositivo hasta acercarte al punto para verlo.
      </p>
    </div>

    <script>
      // Coordenadas del modelo 3D
      const MODEL_LAT = 3.34071628;
      const MODEL_LON = -76.52940404;
      const RANGE_METERS = 20;

      // Haversine formula for distance in meters
      function getDistanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Radio de la tierra en metros
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // Filtro para minimizar ruido GPS
      let lastLat = null;
      let lastLon = null;
      const MIN_DIST_METERS = 0.1; // Solo actualiza si el usuario se mueve más de 10 cm

      document.addEventListener("DOMContentLoaded", function() {
        const model = document.getElementById("model");
        const gpsCam = document.getElementById("gpscam");
        gpsCam.addEventListener("gps-camera-update-position", function(event) {
          const { latitude, longitude } = event.detail.position;
          if (lastLat !== null && lastLon !== null) {
            const dist = getDistanceMeters(latitude, longitude, lastLat, lastLon);
            if (dist < MIN_DIST_METERS) return; // Ignora el cambio si es muy pequeño
          }
          lastLat = latitude;
          lastLon = longitude;

          // Mostrar modelo solo si el usuario está dentro del rango
          const distance = getDistanceMeters(latitude, longitude, MODEL_LAT, MODEL_LON);
          if (distance <= RANGE_METERS) {
            model.setAttribute("visible", "true");
          } else {
            model.setAttribute("visible", "false");
          }
        });
      });
    </script>
  </body>
</html>
