<!DOCTYPE html>
<html>
  <head>
    <title>AR Visual Modelo Fijo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      style="width: 100vw; height: 100vh;"
    >
      <a-camera gps-camera rotation-reader id="gpscam"></a-camera>
      <a-entity
        id="model"
        gps-entity-place="latitude: 3.34071628; longitude: -76.52940404; altitude: 1020.56742902"
        gltf-model="logocelsia.glb"
        scale="1 1 1"
        position="0 0 0"
        visible="false"
      ></a-entity>
    </a-scene>
    <div style="position: absolute; bottom: 10px; text-align: center; width: 100%;">
      <p>
        El modelo 3D aparecerá al acercarte y se <b>quedará fijo visualmente</b> donde apareció.
      </p>
    </div>
    <script>
      // --- Configuración del modelo ---
      const MODEL_LAT = 3.34071628;
      const MODEL_LON = -76.52940404;
      const RANGE_METERS = 20;

      function getDistanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      let fixed = false;
      let fixedPos = null;
      let fixedQuat = null;

      document.addEventListener("DOMContentLoaded", function() {
        const model = document.getElementById("model");
        const gpsCam = document.getElementById("gpscam");

        gpsCam.addEventListener("gps-camera-update-position", function(event) {
          const { latitude, longitude } = event.detail.position;
          const distance = getDistanceMeters(latitude, longitude, MODEL_LAT, MODEL_LON);

          if (distance <= RANGE_METERS && !fixed) {
            model.setAttribute("visible", "true");
            // Espera a que AR.js posicione el modelo, luego lo "fija" visualmente
            setTimeout(() => {
              fixedPos = model.object3D.position.clone();
              fixedQuat = model.object3D.quaternion.clone();
              model.removeAttribute('gps-entity-place');
              fixed = true;
            }, 100); // Ajusta el delay si es necesario
          }
        });

        // Fuerza la posición y orientación cada frame
        AFRAME.registerComponent('freeze-visual', {
          tick: function () {
            if (fixed && fixedPos && fixedQuat) {
              model.object3D.position.copy(fixedPos);
              model.object3D.quaternion.copy(fixedQuat);
            }
          }
        });
        model.setAttribute('freeze-visual', '');
      });
    </script>
  </body>
</html>
