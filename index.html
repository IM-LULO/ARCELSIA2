<!DOCTYPE html>
<html>
  <head>
    <title>AR Experience with Coordinates</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <!-- Cámara GPS -->
      <a-camera gps-camera rotation-reader position="0 0 0"></a-camera>
      <script>
        const targetLatitude = 3.340495;
        const targetLongitude = -76.529405;
        const targetAltitude = 1045; // Altitud en metros
        const tolerance = 0.001; // Tolerancia (~100 metros)

        function isWithinTolerance(userLat, userLon, userAlt) {
          const toRad = (value) => (value * Math.PI) / 180;
          const R = 6371; // Radio de la Tierra en km
          const dLat = toRad(userLat - targetLatitude);
          const dLon = toRad(userLon - targetLongitude);
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRad(targetLatitude)) *
              Math.cos(toRad(userLat)) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          const distance = R * c * 1000; // Distancia en metros

          // Validar también la altitud con una tolerancia de 2 metros
          const altitudeDifference = Math.abs(userAlt - targetAltitude);
          const altitudeTolerance = 2; // Tolerancia en metros

          return distance <= tolerance * 111000 && altitudeDifference <= altitudeTolerance;
        }

        document.querySelector("[gps-camera]").addEventListener("gps-camera-update-position", (event) => {
          const { latitude, longitude, altitude } = event.detail.position;
          console.log("Latitud:", latitude, "Longitud:", longitude, "Altitud:", altitude);

          if (isWithinTolerance(latitude, longitude, altitude)) {
            console.log("Dentro del rango, mostrando el modelo.");
            document.querySelector("#model").setAttribute("visible", "true");
          } else {
            console.log("Fuera del rango, ocultando el modelo.");
            document.querySelector("#model").setAttribute("visible", "false");
          }
        });
      </script>
      
      <!-- Icono de ubicación rojo -->
      <a-entity
        gps-entity-place="latitude: 3.340495; longitude: -76.529405; altitude: 1045;"
        geometry="primitive: cone; height: 2; radiusBottom: 0.5; radiusTop: 0;"
        material="color: red;"
      ></a-entity>

      <!-- Modelo 3D -->
      <a-entity
        id="model"
        gps-entity-place="latitude: 3.340495; longitude: -76.529405; altitude: 1045;"
        glb-model="logocelsia.glb"
        scale="1 1 1" <!-- Escala en tamaño real -->
        position="0 0 0" <!-- Ajusta la posición si el modelo no aparece en el lugar esperado -->
        visible="true" <!-- Visible por defecto para pruebas -->
      ></a-entity>
    </a-scene>
    <div style="position: absolute; bottom: 10px; text-align: center; width: 100%; color: white; background: rgba(0,0,0,0.5); padding: 5px;">
      <p>Muévete para ver el modelo 3D en las coordenadas especificadas.</p>
    </div>
  </body>
</html>
